<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ÙØ­Øµ Supabase - Elite Investors</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }
        body {
            background: #0f172a;
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            color: #7c3aed;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .card {
            background: #1e293b;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #7c3aed;
        }
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #7c3aed;
            font-size: 18px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
        }
        .test-item {
            padding: 15px;
            background: #0f172a;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-name {
            font-weight: bold;
            color: #cbd5e1;
        }
        .test-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .status-pending {
            background: #f59e0b20;
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }
        .status-success {
            background: #10b98120;
            color: #10b981;
            border: 1px solid #10b981;
        }
        .status-error {
            background: #ef444420;
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        .test-details {
            background: #00000030;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            color: #94a3b8;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 10px;
            display: none;
        }
        .test-details.show {
            display: block;
        }
        .btn {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
        }
        .btn-outline {
            background: transparent;
            border: 2px solid #7c3aed;
            color: #7c3aed;
        }
        .row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .badge {
            background: #334155;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        hr {
            border: none;
            border-top: 1px solid #334155;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid #334155;
        }
        th {
            color: #7c3aed;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        .login-form input {
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
        }
        .login-form button {
            background: #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <i class="fas fa-search"></i>
            ğŸ” ÙØ­Øµ Supabase Ø§Ù„Ø´Ø§Ù…Ù„
        </h1>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-plug"></i>
                ğŸ“¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
            </div>
            <div id="connection-info" class="test-item">
                Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„...
            </div>
        </div>

        <!-- ÙØ­Øµ RLS -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-shield"></i>
                ğŸ”’ ÙØ­Øµ RLS (Row Level Security)
            </div>
            <div id="rls-test" class="test-item">
                Ø¬Ø§Ø±ÙŠ ÙØ­Øµ RLS...
            </div>
        </div>

        <!-- ÙØ­Øµ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-table"></i>
                ğŸ“Š ÙØ­Øµ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
            </div>
            <div id="tables-test"></div>
        </div>

        <!-- ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-users"></i>
                ğŸ‘¥ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            </div>
            <div id="users-test"></div>
        </div>

        <!-- ÙØ­Øµ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-crown"></i>
                ğŸ“¦ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ù‚Ø§Øª
            </div>
            <div id="packages-test"></div>
        </div>

        <!-- Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-key"></i>
                ğŸ”‘ Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            </div>
            <div class="login-form">
                <input type="text" id="test-username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" value="admin">
                <input type="password" id="test-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value="admin123">
                <button class="btn" onclick="testLogin()">ğŸ”“ ØªØ¬Ø±Ø¨Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
            <div id="login-result" style="margin-top: 15px; padding: 10px; background: #0f172a; border-radius: 8px;"></div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="row">
            <button class="btn btn-outline" onclick="runAllTests()" style="flex: 1;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ</button>
            <button class="btn btn-outline" onclick="fixRLS()" style="flex: 1;">ğŸ”§ Ø¥ØµÙ„Ø§Ø­ RLS</button>
        </div>
        <button class="btn" onclick="window.location.reload()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</button>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-bug"></i>
                ğŸ› Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            </div>
            <div id="error-log" style="background: #0f172a; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
        const SUPABASE_URL = 'https://kfwbcewtnfoofllhxron.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtmd2JjZXd0bmZvb2ZsbGh4cm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjEwMzksImV4cCI6MjA4NjQ5NzAzOX0.Mgf7Dg4Ji3eKHQPz3SUGTfwSfsl7anYneA4ZPIYgbIU';

        let supabase = null;
        let testResults = {};

        // Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        function logError(message, error = null) {
            const logDiv = document.getElementById('error-log');
            const time = new Date().toLocaleTimeString();
            const errorMsg = error ? `${error.message || error}` : '';
            logDiv.innerHTML = `<div style="color: #ef4444;">âŒ [${time}] ${message} ${errorMsg}</div>` + logDiv.innerHTML;
            console.error(message, error);
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø¬Ø§Ø­
        function logSuccess(message) {
            const logDiv = document.getElementById('error-log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `<div style="color: #10b981;">âœ… [${time}] ${message}</div>` + logDiv.innerHTML;
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        function logInfo(message) {
            const logDiv = document.getElementById('error-log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `<div style="color: #3b82f6;">â„¹ï¸ [${time}] ${message}</div>` + logDiv.innerHTML;
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        async function initSupabase() {
            try {
                if (typeof supabase === 'undefined') {
                    throw new Error('Ù…ÙƒØªØ¨Ø© Supabase ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©');
                }
                supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                if (!supabase) {
                    throw new Error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase');
                }

                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                const { error } = await supabase.from('users').select('count', { count: 'exact', head: true });
                
                if (error && error.code === '42P01') {
                    document.getElementById('connection-info').innerHTML = `
                        <div class="test-header">
                            <span class="test-name">âš ï¸ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</span>
                            <span class="test-status status-warning">ØªØ­Ø°ÙŠØ±</span>
                        </div>
                        <div class="test-details show">
                            <strong>Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</strong> Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯<br>
                            <strong>Ø§Ù„Ø­Ù„:</strong> Ù†ÙØ° Ø£ÙˆØ§Ù…Ø± SQL Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                        </div>
                    `;
                    logError('âš ï¸ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© - ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹');
                } else if (error) {
                    throw error;
                } else {
                    document.getElementById('connection-info').innerHTML = `
                        <div class="test-header">
                            <span class="test-name">âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­</span>
                            <span class="test-status status-success">Ù†Ø§Ø¬Ø­</span>
                        </div>
                        <div class="test-details show">
                            <strong>URL:</strong> ${SUPABASE_URL}<br>
                            <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> Ù…ØªØµÙ„
                        </div>
                    `;
                    logSuccess('Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ø¬Ø­');
                }

                return supabase;
            } catch (error) {
                document.getElementById('connection-info').innerHTML = `
                    <div class="test-header">
                        <span class="test-name">âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„</span>
                        <span class="test-status status-error">Ø®Ø·Ø£</span>
                    </div>
                    <div class="test-details show">
                        <strong>Ø§Ù„Ø®Ø·Ø£:</strong> ${error.message}<br>
                        <strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${JSON.stringify(error)}
                    </div>
                `;
                logError('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', error);
                return null;
            }
        }

        // ÙØ­Øµ RLS
        async function checkRLS() {
            if (!supabase) return;

            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                const { data: users, error: selectError } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªØ¨Ø§Ø±)
                const testId = crypto.randomUUID?.() || 'test-id';
                const { error: insertError } = await supabase
                    .from('users')
                    .insert({ 
                        id: testId,
                        name: 'test',
                        username: 'test',
                        email: 'test@test.com',
                        phone: '1234567890',
                        password: 'test'
                    })
                    .maybeSingle();

                let rlsStatus = '';
                let rlsDetails = '';

                if (selectError && selectError.code === '42501') {
                    rlsStatus += 'âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (RLS ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©)\n';
                } else if (!selectError) {
                    rlsStatus += 'âœ… ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n';
                }

                if (insertError && insertError.code === '42501') {
                    rlsStatus += 'âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (RLS ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©)';
                } else if (!insertError) {
                    rlsStatus += 'âœ… ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†';
                    // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ
                    await supabase.from('users').delete().eq('id', testId);
                }

                document.getElementById('rls-test').innerHTML = `
                    <div class="test-header">
                        <span class="test-name">${insertError || selectError ? 'âš ï¸ RLS Ù†Ø´Ø·' : 'âœ… RLS Ù…ÙØªÙˆØ­'}</span>
                        <span class="test-status ${insertError || selectError ? 'status-warning' : 'status-success'}">${insertError || selectError ? 'Ù…Ù‚ÙŠØ¯' : 'Ù…ÙØªÙˆØ­'}</span>
                    </div>
                    <div class="test-details show">
                        <pre style="white-space: pre-wrap;">${rlsStatus || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ RLS'}</pre>
                        ${insertError ? `<small class="error">${insertError.message}</small>` : ''}
                    </div>
                `;

                logInfo(`Ø­Ø§Ù„Ø© RLS: ${insertError || selectError ? 'Ù…Ù‚ÙŠØ¯' : 'Ù…ÙØªÙˆØ­'}`);
                return !insertError && !selectError;
            } catch (error) {
                logError('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ RLS', error);
            }
        }

        // ÙØ­Øµ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
        async function checkTables() {
            if (!supabase) return;

            const tables = ['users', 'packages', 'tasks', 'transactions', 'withdrawals', 'pending_packages', 'system_settings'];
            const tablesDiv = document.getElementById('tables-test');
            let html = '';

            for (const table of tables) {
                try {
                    const { count, error } = await supabase
                        .from(table)
                        .select('*', { count: 'exact', head: true });

                    if (error && error.code === '42P01') {
                        html += `
                            <div class="test-item">
                                <div class="test-header">
                                    <span class="test-name">${table}</span>
                                    <span class="test-status status-error">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</span>
                                </div>
                                <div class="test-details show error">
                                    âŒ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                </div>
                            </div>
                        `;
                        logError(`Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${table}`);
                    } else if (error) {
                        html += `
                            <div class="test-item">
                                <div class="test-header">
                                    <span class="test-name">${table}</span>
                                    <span class="test-status status-error">Ø®Ø·Ø£</span>
                                </div>
                                <div class="test-details show error">
                                    ${error.message}
                                </div>
                            </div>
                        `;
                        logError(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ${table}: ${error.message}`);
                    } else {
                        html += `
                            <div class="test-item">
                                <div class="test-header">
                                    <span class="test-name">${table}</span>
                                    <span class="test-status status-success">Ù…ÙˆØ¬ÙˆØ¯</span>
                                </div>
                                <div class="test-details show">
                                    âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${count || 0}
                                </div>
                            </div>
                        `;
                        logSuccess(`Ø§Ù„Ø¬Ø¯ÙˆÙ„ ${table} Ù…ÙˆØ¬ÙˆØ¯ (${count || 0} Ø³Ø¬Ù„)`);
                    }
                } catch (error) {
                    html += `
                        <div class="test-item">
                            <div class="test-header">
                                <span class="test-name">${table}</span>
                                <span class="test-status status-error">Ø®Ø·Ø£</span>
                            </div>
                            <div class="test-details show error">
                                ${error.message}
                            </div>
                        </div>
                    `;
                    logError(`Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ${table}: ${error.message}`);
                }
            }

            tablesDiv.innerHTML = html;
        }

        // ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        async function checkUsers() {
            if (!supabase) return;

            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*');

                if (error) throw error;

                const usersDiv = document.getElementById('users-test');
                
                if (!users || users.length === 0) {
                    usersDiv.innerHTML = `
                        <div class="test-item">
                            <div class="test-header">
                                <span class="test-name">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                                <span class="test-status status-warning">ØªØ­Ø°ÙŠØ±</span>
                            </div>
                            <div class="test-details show">
                                Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø¶ÙŠØ© - ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹
                            </div>
                        </div>
                    `;
                    logError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    return;
                }

                let html = `<div class="test-item">`;
                html += `<div class="test-header">`;
                html += `<span class="test-name">âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${users.length}</span>`;
                html += `<span class="test-status status-success">Ù†Ø§Ø¬Ø­</span>`;
                html += `</div>`;
                html += `<div class="test-details show">`;
                
                users.forEach(user => {
                    html += `<div style="margin-bottom: 15px; padding: 10px; background: #0f172a; border-radius: 8px;">`;
                    html += `<strong>${user.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</strong><br>`;
                    html += `<small>ğŸ‘¤ ${user.username} | ğŸ”‘ ${user.password} | `;
                    html += `${user.is_admin ? 'ğŸ‘‘ Ù…Ø´Ø±Ù' : 'ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù…'}</small><br>`;
                    html += `<small>ğŸ“§ ${user.email}</small><br>`;
                    html += `<small>ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: ${user.balance || 0}$</small><br>`;
                    html += `<small>ğŸ”— ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: ${user.referral_code || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</small>`;
                    html += `</div>`;
                });
                
                html += `</div></div>`;
                usersDiv.innerHTML = html;

                logSuccess(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${users.length} Ù…Ø³ØªØ®Ø¯Ù…`);

                // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
                window.testUsers = users;

            } catch (error) {
                document.getElementById('users-test').innerHTML = `
                    <div class="test-item">
                        <div class="test-header">
                            <span class="test-name">âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                            <span class="test-status status-error">Ø®Ø·Ø£</span>
                        </div>
                        <div class="test-details show error">
                            ${error.message}
                        </div>
                    </div>
                `;
                logError('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', error);
            }
        }

        // ÙØ­Øµ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª
        async function checkPackages() {
            if (!supabase) return;

            try {
                const { data: packages, error } = await supabase
                    .from('packages')
                    .select('*');

                if (error) throw error;

                const packagesDiv = document.getElementById('packages-test');
                
                if (!packages || packages.length === 0) {
                    packagesDiv.innerHTML = `
                        <div class="test-item">
                            <div class="test-header">
                                <span class="test-name">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù‚Ø§Øª</span>
                                <span class="test-status status-warning">ØªØ­Ø°ÙŠØ±</span>
                            </div>
                            <div class="test-details show">
                                ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
                            </div>
                        </div>
                    `;
                    logError('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù‚Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    return;
                }

                let html = `<div class="test-item">`;
                html += `<div class="test-header">`;
                html += `<span class="test-name">âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª: ${packages.length}</span>`;
                html += `<span class="test-status status-success">Ù†Ø§Ø¬Ø­</span>`;
                html += `</div>`;
                html += `<div class="test-details show">`;
                
                packages.forEach(pkg => {
                    html += `<div style="margin-bottom: 10px; padding: 8px; background: #0f172a; border-radius: 6px;">`;
                    html += `<strong>${pkg.name}</strong> - ${pkg.price}$ `;
                    html += `<span class="badge">${pkg.category}</span><br>`;
                    html += `<small>ğŸ“ˆ Ø±Ø¨Ø­ ÙŠÙˆÙ…ÙŠ: ${pkg.daily_profit || (pkg.price * 0.025)}$</small>`;
                    html += `</div>`;
                });
                
                html += `</div></div>`;
                packagesDiv.innerHTML = html;

                logSuccess(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${packages.length} Ø¨Ø§Ù‚Ø©`);

            } catch (error) {
                document.getElementById('packages-test').innerHTML = `
                    <div class="test-item">
                        <div class="test-header">
                            <span class="test-name">âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</span>
                            <span class="test-status status-error">Ø®Ø·Ø£</span>
                        </div>
                        <div class="test-details show error">
                            ${error.message}
                        </div>
                    </div>
                `;
                logError('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª', error);
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function testLogin() {
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            const resultDiv = document.getElementById('login-result');

            resultDiv.innerHTML = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .or(`username.eq.${username},email.eq.${username}`)
                    .eq('password', password)
                    .maybeSingle();

                if (error) throw error;

                if (user) {
                    resultDiv.innerHTML = `
                        <div style="color: #10b981;">
                            âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­<br>
                            ğŸ‘¤ ${user.name}<br>
                            ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: ${user.balance || 0}$
                        </div>
                    `;
                    logSuccess(`ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­: ${user.username}`);
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: #ef4444;">
                            âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©
                        </div>
                    `;
                    logError('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: #ef4444;">
                        âŒ Ø®Ø·Ø£: ${error.message}
                    </div>
                `;
                logError('Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', error);
            }
        }

        // Ø¥ØµÙ„Ø§Ø­ RLS
        async function fixRLS() {
            if (!supabase) return;

            const confirmFix = confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹Ø·ÙŠÙ„ RLS Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹ØŸ Ù‡Ø°Ø§ Ø³ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„.');
            if (!confirmFix) return;

            try {
                // ØªØ¹Ø·ÙŠÙ„ RLS Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                const tables = ['users', 'packages', 'tasks', 'transactions', 'withdrawals', 'pending_packages'];
                
                for (const table of tables) {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø·ÙŠÙ„ RLS (ÙŠØ­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ§Øª)
                    const { error } = await supabase.rpc('disable_rls_for_table', { table_name: table });
                    
                    if (error) {
                        logError(`ÙØ´Ù„ ØªØ¹Ø·ÙŠÙ„ RLS Ù„Ù„Ø¬Ø¯ÙˆÙ„ ${table}: ${error.message}`);
                    } else {
                        logSuccess(`ØªÙ… ØªØ¹Ø·ÙŠÙ„ RLS Ù„Ù„Ø¬Ø¯ÙˆÙ„ ${table}`);
                    }
                }

                alert('âœ… ØªÙ…Øª Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø·ÙŠÙ„ RLS. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.');
                runAllTests();

            } catch (error) {
                logError('ÙØ´Ù„ ØªØ¹Ø·ÙŠÙ„ RLS', error);
                alert('âŒ ÙØ´Ù„ ØªØ¹Ø·ÙŠÙ„ RLS. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„ØªÙ†ÙÙŠØ° Ø£ÙˆØ§Ù…Ø± SQL ÙŠØ¯ÙˆÙŠØ§Ù‹.');
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        async function runAllTests() {
            logInfo('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª...');
            
            supabase = await initSupabase();
            if (!supabase) return;

            await checkRLS();
            await checkTables();
            await checkUsers();
            await checkPackages();

            logSuccess('âœ… Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª');
        }

        // ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = () => {
            setTimeout(runAllTests, 1000);
        };

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
        window.testLogin = testLogin;
        window.runAllTests = runAllTests;
        window.fixRLS = fixRLS;
    </script>
    <!-- Font Awesome Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Investors | لوحة الإدارة</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #0f172a;
            color: white;
        }

        .sidebar {
            width: 280px;
            background: #1e293b;
            position: fixed;
            height: 100vh;
            padding: 20px;
            border-left: 1px solid rgba(139, 92, 246, 0.2);
        }

        .sidebar-header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            color: white;
        }

        .main-content {
            margin-right: 280px;
            padding: 20px;
        }

        .admin-header {
            background: #1e293b;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .stat-icon {
            font-size: 32px;
            color: #8b5cf6;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #10b981;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .admin-table {
            background: #1e293b;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .admin-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th {
            background: rgba(139, 92, 246, 0.15);
            padding: 15px;
            text-align: right;
        }

        .admin-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 2px solid #8b5cf6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #94a3b8;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            color: white;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }

        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            display: none;
            z-index: 3000;
        }

        .notification.error {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">Elite Investors</div>
            <small>لوحة الإدارة</small>
        </div>

        <ul class="sidebar-menu">
            <li><a class="active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
            <li><a onclick="showSection('users')"><i class="fas fa-users"></i> المستخدمين</a></li>
            <li><a onclick="showSection('packages')"><i class="fas fa-crown"></i> الباقات</a></li>
            <li><a onclick="showSection('tasks')"><i class="fas fa-tasks"></i> المهام</a></li>
            <li><a onclick="showSection('pending')"><i class="fas fa-clock"></i> الطلبات المعلقة</a></li>
            <li><a onclick="showSection('withdrawals')"><i class="fas fa-money-bill-wave"></i> طلبات السحب</a></li>
            <li><a href="index.html"><i class="fas fa-sign-out-alt"></i> العودة للموقع</a></li>
        </ul>
    </div>

    <div class="main-content">
        <!-- لوحة التحكم -->
        <div id="dashboard-section" class="section active">
            <div class="admin-header">
                <h2>نظرة عامة على النظام</h2>
                <button class="btn btn-sm" onclick="loadDashboard()">تحديث</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div>إجمالي المستخدمين</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-crown"></i></div>
                    <div class="stat-value" id="totalPackages">0</div>
                    <div>الباقات</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-tasks"></i></div>
                    <div class="stat-value" id="totalTasks">0</div>
                    <div>المهام</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-value" id="totalPending">0</div>
                    <div>طلبات معلقة</div>
                </div>
            </div>
        </div>

        <!-- المستخدمين -->
        <div id="users-section" class="section">
            <div class="admin-header">
                <h2>إدارة المستخدمين</h2>
                <button class="btn btn-sm" onclick="showAddUserModal()">إضافة مستخدم</button>
            </div>

            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>البريد</th>
                            <th>الرصيد</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <tr><td colspan="6">جاري التحميل...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- الباقات -->
        <div id="packages-section" class="section">
            <div class="admin-header">
                <h2>إدارة الباقات</h2>
                <button class="btn btn-sm" onclick="showAddPackageModal()">إضافة باقة</button>
            </div>

            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>السعر</th>
                            <th>الربح</th>
                            <th>الفئة</th>
                            <th>المهام</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="packagesTable">
                        <tr><td colspan="6">جاري التحميل...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- المهام -->
        <div id="tasks-section" class="section">
            <div class="admin-header">
                <h2>إدارة المهام</h2>
                <button class="btn btn-sm" onclick="showAddTaskModal()">إضافة مهمة</button>
            </div>

            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>العنوان</th>
                            <th>المكافأة</th>
                            <th>الفئة</th>
                            <th>الصعوبة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTable">
                        <tr><td colspan="5">جاري التحميل...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- الطلبات المعلقة -->
        <div id="pending-section" class="section">
            <div class="admin-header">
                <h2>طلبات الاشتراك</h2>
            </div>

            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>المستخدم</th>
                            <th>الباقة</th>
                            <th>المبلغ</th>
                            <th>التاريخ</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTable">
                        <tr><td colspan="5">جاري التحميل...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- طلبات السحب -->
        <div id="withdrawals-section" class="section">
            <div class="admin-header">
                <h2>طلبات السحب</h2>
            </div>

            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>المستخدم</th>
                            <th>المبلغ</th>
                            <th>المحفظة</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalsTable">
                        <tr><td colspan="5">جاري التحميل...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة مستخدم -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <h2>إضافة مستخدم</h2>
            <div class="form-group">
                <label>الاسم</label>
                <input type="text" class="form-control" id="userName">
            </div>
            <div class="form-group">
                <label>البريد</label>
                <input type="email" class="form-control" id="userEmail">
            </div>
            <div class="form-group">
                <label>كلمة المرور</label>
                <input type="password" class="form-control" id="userPassword" value="123456">
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-sm" onclick="closeModal('addUserModal')">إلغاء</button>
                <button class="btn btn-sm" onclick="addUser()">إضافة</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة باقة -->
    <div class="modal" id="addPackageModal">
        <div class="modal-content">
            <h2>إضافة باقة</h2>
            <div class="form-group">
                <label>اسم الباقة</label>
                <input type="text" class="form-control" id="packageName">
            </div>
            <div class="form-group">
                <label>السعر</label>
                <input type="number" class="form-control" id="packagePrice">
            </div>
            <div class="form-group">
                <label>نسبة الربح</label>
                <input type="number" class="form-control" id="packageProfit" value="2.5">
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-sm" onclick="closeModal('addPackageModal')">إلغاء</button>
                <button class="btn btn-sm" onclick="addPackage()">إضافة</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة مهمة -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <h2>إضافة مهمة</h2>
            <div class="form-group">
                <label>عنوان المهمة</label>
                <input type="text" class="form-control" id="taskTitle">
            </div>
            <div class="form-group">
                <label>المكافأة</label>
                <input type="number" class="form-control" id="taskReward">
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-sm" onclick="closeModal('addTaskModal')">إلغاء</button>
                <button class="btn btn-sm" onclick="addTask()">إضافة</button>
            </div>
        </div>
    </div>

    <!-- الإشعار -->
    <div class="notification" id="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <script>
        // ========== التنقل بين الأقسام ==========
        window.showSection = function(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
            
            document.getElementById(section + '-section').classList.add('active');
            event.currentTarget.classList.add('active');
            
            // تحميل البيانات
            if (section === 'users') loadUsers();
            if (section === 'packages') loadPackages();
            if (section === 'tasks') loadTasks();
            if (section === 'pending') loadPending();
            if (section === 'withdrawals') loadWithdrawals();
        };

        // ========== الإشعارات ==========
        function showNotification(msg, type = 'success') {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = 'notification ' + type;
            n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 3000);
        }

        // ========== إغلاق النوافذ ==========
        window.closeModal = function(id) {
            document.getElementById(id).classList.remove('active');
        };

        // ========== المستخدمين ==========
        async function loadUsers() {
            const tbody = document.getElementById('usersTable');
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                let html = '';
                data.forEach((user, i) => {
                    html += `<tr>
                        <td>${i+1}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.balance || 0}$</td>
                        <td><span class="status-badge status-active">${user.status || 'active'}</span></td>
                        <td>
                            <button class="btn btn-sm" onclick="deleteUser(${user.id})">حذف</button>
                        </td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6">خطأ في التحميل</td></tr>';
            }
        }

        window.showAddUserModal = function() {
            document.getElementById('addUserModal').classList.add('active');
        };

        window.addUser = async function() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            
            if (!name || !email) {
                showNotification('جميع الحقول مطلوبة', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .insert([{
                        name,
                        email,
                        password,
                        balance: 0,
                        status: 'active',
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) throw error;
                
                closeModal('addUserModal');
                loadUsers();
                showNotification('✅ تمت الإضافة');
            } catch (error) {
                showNotification('❌ فشلت الإضافة', 'error');
            }
        };

        window.deleteUser = async function(id) {
            if (!confirm('تأكيد الحذف؟')) return;
            
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                loadUsers();
                showNotification('✅ تم الحذف');
            } catch (error) {
                showNotification('❌ فشل الحذف', 'error');
            }
        };

        // ========== الباقات ==========
        async function loadPackages() {
            const tbody = document.getElementById('packagesTable');
            
            try {
                const { data, error } = await supabase
                    .from('packages')
                    .select('*');
                
                if (error) throw error;
                
                let html = '';
                data.forEach(pkg => {
                    html += `<tr>
                        <td>${pkg.name}</td>
                        <td>${pkg.price}$</td>
                        <td>${pkg.profit || 2.5}%</td>
                        <td>${pkg.category || 'standard'}</td>
                        <td>${pkg.tasks_count || 5}</td>
                        <td>
                            <button class="btn btn-sm" onclick="deletePackage(${pkg.id})">حذف</button>
                        </td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6">خطأ في التحميل</td></tr>';
            }
        }

        window.showAddPackageModal = function() {
            document.getElementById('addPackageModal').classList.add('active');
        };

        window.addPackage = async function() {
            const name = document.getElementById('packageName').value;
            const price = parseFloat(document.getElementById('packagePrice').value);
            const profit = parseFloat(document.getElementById('packageProfit').value);
            
            if (!name || !price) {
                showNotification('جميع الحقول مطلوبة', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('packages')
                    .insert([{
                        name,
                        price,
                        profit,
                        status: 'active',
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) throw error;
                
                closeModal('addPackageModal');
                loadPackages();
                showNotification('✅ تمت الإضافة');
            } catch (error) {
                showNotification('❌ فشلت الإضافة', 'error');
            }
        };

        window.deletePackage = async function(id) {
            if (!confirm('تأكيد الحذف؟')) return;
            
            try {
                const { error } = await supabase
                    .from('packages')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                loadPackages();
                showNotification('✅ تم الحذف');
            } catch (error) {
                showNotification('❌ فشل الحذف', 'error');
            }
        };

        // ========== المهام ==========
        async function loadTasks() {
            const tbody = document.getElementById('tasksTable');
            
            try {
                const { data, error } = await supabase
                    .from('tasks')
                    .select('*');
                
                if (error) throw error;
                
                let html = '';
                data.forEach(task => {
                    html += `<tr>
                        <td>${task.title}</td>
                        <td>${task.reward}$</td>
                        <td>${task.package_categories?.join(', ') || 'all'}</td>
                        <td>${task.difficulty || 'medium'}</td>
                        <td>
                            <button class="btn btn-sm" onclick="deleteTask(${task.id})">حذف</button>
                        </td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5">خطأ في التحميل</td></tr>';
            }
        }

        window.showAddTaskModal = function() {
            document.getElementById('addTaskModal').classList.add('active');
        };

        window.addTask = async function() {
            const title = document.getElementById('taskTitle').value;
            const reward = parseFloat(document.getElementById('taskReward').value);
            
            if (!title || !reward) {
                showNotification('جميع الحقول مطلوبة', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('tasks')
                    .insert([{
                        title,
                        reward,
                        status: 'active',
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) throw error;
                
                closeModal('addTaskModal');
                loadTasks();
                showNotification('✅ تمت الإضافة');
            } catch (error) {
                showNotification('❌ فشلت الإضافة', 'error');
            }
        };

        window.deleteTask = async function(id) {
            if (!confirm('تأكيد الحذف؟')) return;
            
            try {
                const { error } = await supabase
                    .from('tasks')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                loadTasks();
                showNotification('✅ تم الحذف');
            } catch (error) {
                showNotification('❌ فشل الحذف', 'error');
            }
        };

        // ========== الطلبات المعلقة ==========
        async function loadPending() {
            const tbody = document.getElementById('pendingTable');
            
            try {
                const { data, error } = await supabase
                    .from('pending_packages')
                    .select('*')
                    .eq('status', 'pending');
                
                if (error) throw error;
                
                let html = '';
                data.forEach(req => {
                    html += `<tr>
                        <td>${req.user_name}</td>
                        <td>${req.package_name}</td>
                        <td>${req.amount}$</td>
                        <td>${new Date(req.created_at).toLocaleDateString('ar-SA')}</td>
                        <td>
                            <button class="btn btn-sm" onclick="approveRequest(${req.id})">قبول</button>
                            <button class="btn btn-sm" onclick="rejectRequest(${req.id})">رفض</button>
                        </td>
                    </tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="5">لا توجد طلبات</td></tr>';
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5">خطأ في التحميل</td></tr>';
            }
        }

        window.approveRequest = async function(id) {
            try {
                const { error } = await supabase
                    .from('pending_packages')
                    .update({ status: 'approved' })
                    .eq('id', id);
                
                if (error) throw error;
                
                loadPending();
                showNotification('✅ تم قبول الطلب');
            } catch (error) {
                showNotification('❌ فشل', 'error');
            }
        };

        window.rejectRequest = async function(id) {
            try {
                const { error } = await supabase
                    .from('pending_packages')
                    .update({ status: 'rejected' })
                    .eq('id', id);
                
                if (error) throw error;
                
                loadPending();
                showNotification('✅ تم رفض الطلب');
            } catch (error) {
                showNotification('❌ فشل', 'error');
            }
        };

        // ========== طلبات السحب ==========
        async function loadWithdrawals() {
            const tbody = document.getElementById('withdrawalsTable');
            
            try {
                const { data, error } = await supabase
                    .from('withdrawals')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                let html = '';
                data.forEach(w => {
                    html += `<tr>
                        <td>${w.user_name}</td>
                        <td>${w.amount}$</td>
                        <td>${w.wallet?.substring(0, 10)}...</td>
                        <td><span class="status-badge status-pending">${w.status}</span></td>
                        <td>
                            <button class="btn btn-sm" onclick="processWithdrawal(${w.id})">معالجة</button>
                        </td>
                    </tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="5">لا توجد طلبات</td></tr>';
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5">خطأ في التحميل</td></tr>';
            }
        }

        window.processWithdrawal = async function(id) {
            if (!confirm('تأكيد إتمام السحب؟')) return;
            
            try {
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ status: 'completed' })
                    .eq('id', id);
                
                if (error) throw error;
                
                loadWithdrawals();
                showNotification('✅ تمت المعالجة');
            } catch (error) {
                showNotification('❌ فشل', 'error');
            }
        };

        // ========== لوحة التحكم ==========
        async function loadDashboard() {
            try {
                const users = await supabase.from('users').select('*', { count: 'exact', head: true });
                const packages = await supabase.from('packages').select('*', { count: 'exact', head: true });
                const tasks = await supabase.from('tasks').select('*', { count: 'exact', head: true });
                const pending = await supabase.from('pending_packages').select('*', { count: 'exact', head: true }).eq('status', 'pending');
                
                document.getElementById('totalUsers').textContent = users.count || 0;
                document.getElementById('totalPackages').textContent = packages.count || 0;
                document.getElementById('totalTasks').textContent = tasks.count || 0;
                document.getElementById('totalPending').textContent = pending.count || 0;
            } catch (error) {
                console.error('خطأ:', error);
            }
        }

        // ========== التهيئة ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ لوحة الإدارة تعمل');
            loadDashboard();
        });
    </script>
</body>
</html>
